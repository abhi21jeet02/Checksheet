<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MHE Checklist - AI Style with Approval</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1e293b, #111827);
      color: #f3f4f6;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    h2 { text-align:center; font-weight:700; color:#3b82f6; margin-bottom:30px; }
    .card { background: rgba(255,255,255,0.05); border-radius: 20px; padding:30px; margin-bottom:30px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.2); border: 1px solid rgba(59,130,246,0.5); transition: transform 0.3s, box-shadow 0.3s; }
    .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(59,130,246,0.4); }
    label { display:block; margin:15px 0; font-weight:500; color:#f3f4f6; }
    input[type="text"] { width:100%; padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.1); color:#f3f4f6; outline:none; font-size:16px; transition: all 0.3s; }
    input[type="text"]:focus { border-color:#3b82f6; box-shadow:0 0 10px rgba(59,130,246,0.6); backdrop-filter: blur(12px); }
    .checklist { display:flex; flex-wrap:wrap; gap:20px; margin-top:20px; }
    .checklist label { position:relative; display:flex; align-items:center; gap:12px; padding:10px 20px; border-radius:12px; background:rgba(255,255,255,0.05); cursor:pointer; transition: all 0.3s; user-select:none; }
    .checklist label:hover { background: rgba(59,130,246,0.2); transform: scale(1.05); }
    .checklist input[type="checkbox"] { width:24px; height:24px; accent-color:#3b82f6; cursor:pointer; transition: all 0.3s; }
    button { background: linear-gradient(135deg, #3b82f6, #2563eb); color:#fff; font-weight:600; padding:14px 24px; border:none; border-radius:14px; cursor:pointer; font-size:16px; transition: all 0.3s; margin-top:20px; box-shadow: 0 6px 20px rgba(59,130,246,0.3); }
    button:hover { background: linear-gradient(135deg, #2563eb, #3b82f6); transform:translateY(-3px); box-shadow: 0 10px 30px rgba(59,130,246,0.5); }
    select { padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.1); color:#f3f4f6; font-size:16px; outline:none; transition: all 0.3s; margin-bottom:15px; }
    select:hover, select:focus { border-color:#3b82f6; box-shadow:0 0 10px rgba(59,130,246,0.6); }
    table { width:100%; border-collapse:collapse; border-radius:16px; overflow:hidden; box-shadow:0 8px 32px rgba(0,0,0,0.2); margin-top:20px; }
    th, td { text-align:center; padding:12px 10px; font-weight:500; color:#f3f4f6; }
    th { background: rgba(59,130,246,0.9); text-shadow:0 0 4px rgba(0,0,0,0.5); }
    tr:nth-child(even) { background: rgba(255,255,255,0.05); }
    tr:hover { background: rgba(59,130,246,0.2); transform: scale(1.01); transition: all 0.2s; }
    @media (max-width:768px) { .checklist { flex-direction:column; } input[type="text"], select, button { font-size:14px; } }
  </style>
</head>
<body>
<h2>MHE Daily Checklist</h2>

<!-- Role Selection -->
<div class="card" id="role-section">
  <h3>Select Role</h3>
  <select id="roleSelect" onchange="toggleRole()">
    <option value="">-- Select --</option>
    <option value="driver">Driver</option>
    <option value="supervisor">Supervisor</option>
  </select>
</div>

<!-- Driver Form -->
<div class="card" id="form-section" style="display:none;">
  <h3>Fill Checklist (Today)</h3>
  <label>Driver Name: <input type="text" id="driverName" placeholder="Enter Driver Name"></label>
  <div class="checklist">
    <label><input type="checkbox" id="Brakes"> Brakes</label>
    <label><input type="checkbox" id="Steering"> Steering</label>
    <label><input type="checkbox" id="Electrical"> Electrical System</label>
    <label><input type="checkbox" id="Wheel"> Wheel</label>
    <label><input type="checkbox" id="Lights"> Lights</label>
  </div>
  <button onclick="submitForm()">Submit</button>
</div>

<!-- Supervisor View -->
<div class="card" id="view-section" style="display:none;">
  <h3>View Submissions & Approvals</h3>
  <select id="monthSelect" onchange="loadTable()"></select>
  <table id="submissionTable"></table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, doc, collection, getDoc, setDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBx_26h3CD_fRCILcmWLuDUc8v8pzH8Sxo",
  authDomain: "mhe-checksheet.firebaseapp.com",
  projectId: "mhe-checksheet",
  storageBucket: "mhe-checksheet.appspot.com",
  messagingSenderId: "413824836416",
  appId: "1:413824836416:web:63faa90294e161363510a5",
  measurementId: "G-ZQ77KHXXVB"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const MHE_ID = urlParams.get("mhe_id");

const checklistItems = ["Brakes","Steering","Electrical","Wheel","Lights"];

// ---- ROLE TOGGLE ----
window.toggleRole = function(){
  const role = document.getElementById("roleSelect").value;
  document.getElementById("form-section").style.display = role==="driver" ? "block" : "none";
  document.getElementById("view-section").style.display = role==="supervisor" ? "block" : "none";
};

// ---- CHECK ALREADY SUBMITTED ----
async function checkAlreadySubmitted() {
  if (!MHE_ID) {
    alert("⚠️ MHE ID missing! Please scan a valid QR code.");
    return false;
  }

  const driverNameInput = document.getElementById("driverName").value.trim();
  if (!driverNameInput) {
    alert("Driver Name is required!");
    return false;
  }
  window.currentDriver = driverNameInput;

  const today = new Date();
  const day = today.getDate().toString();
  const monthKey = today.getFullYear()+"-"+String(today.getMonth()+1).padStart(2,"0");

  const mheDocRef = doc(db,"checklists",monthKey,"MHEs",MHE_ID);
  const snap = await getDoc(mheDocRef);
  if (snap.exists()) {
    const data = snap.data();
    const submittedDrivers = data.submittedDrivers||{};
    const todayDrivers = submittedDrivers[day]||[];
    if (todayDrivers.includes(driverNameInput)) {
      alert(`Driver ${driverNameInput} has already submitted the checklist today ✅`);
      document.getElementById("form-section").style.display="none";
      return false;
    }
  }
  return true;
}
// ---- FORM SUBMIT ----
async function submitForm(){
  const isAllowed = await checkAlreadySubmitted();
  if(!isAllowed) return;

  const today = new Date();
  const day = today.getDate().toString();
  const monthKey = today.getFullYear()+"-"+String(today.getMonth()+1).padStart(2,"0");

  const mheDocRef = doc(db,"checklists",monthKey,"MHEs",MHE_ID);
  const snap = await getDoc(mheDocRef);
  let data = snap.exists()?snap.data():{ checklist:{}, submittedDrivers:{}, approvals:{} };

  for(let item of checklistItems){
    const checked = document.getElementById(item).checked?"✔":"✖";
    if(!data.checklist[item]) data.checklist[item]={};
    data.checklist[item][day]=checked;
  }

  if(!data.submittedDrivers[day]) data.submittedDrivers[day]=[];
  data.submittedDrivers[day].push(window.currentDriver);

  if(!data.approvals[day]) data.approvals[day]={};
  data.approvals[day][window.currentDriver]={status:"Pending"};

  if(snap.exists()) await updateDoc(mheDocRef,data);
  else await setDoc(mheDocRef,data);

  alert("Checklist submitted for today ✅");
  document.getElementById("form-section").style.display="none";
}

// ---- APPROVE FUNCTION ----
async function approveChecklist(mheId, driver, day){
  const monthKey = document.getElementById("monthSelect").value;
  const mheDocRef = doc(db,"checklists",monthKey,"MHEs",mheId);
  const snap = await getDoc(mheDocRef);
  if(!snap.exists()) return;
  let data = snap.data();
  if(!data.approvals[day]) data.approvals[day]={};
  data.approvals[day][driver]={status:"Approved", time:new Date().toLocaleTimeString()};
  await updateDoc(mheDocRef,data);
  loadTable();
}

// ---- POPULATE MONTH DROPDOWN ----
function populateMonths(){
  const select = document.getElementById("monthSelect");
  const now = new Date();
  for(let i=0;i<6;i++){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    const key = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = d.toLocaleString("default",{month:"long", year:"numeric"});
    select.appendChild(opt);
  }
}

// ---- LOAD TABLE ----
async function loadTable(){
  const monthKey = document.getElementById("monthSelect").value;
  const mheColRef = collection(db,"checklists",monthKey,"MHEs");
  const mheSnap = await getDocs(mheColRef);

  const table = document.getElementById("submissionTable");
  table.innerHTML="";

  if(mheSnap.empty){ table.innerHTML="<tr><td>No data for this month</td></tr>"; return; }

  const daysInMonth = new Date(parseInt(monthKey.split("-")[0]),parseInt(monthKey.split("-")[1]),0).getDate();

  let header = "<tr><th>MHE ID</th><th>Item</th><th>Driver</th><th>Approval</th>";
  for(let d=1;d<=daysInMonth;d++) header+=`<th>${d}</th>`;
  header+="</tr>";
  table.innerHTML+=header;

  for(let mheDoc of mheSnap.docs){
    const mheId = mheDoc.id;
    const data = mheDoc.data().checklist||{};
    const approvals = mheDoc.data().approvals||{};
    const submittedDrivers = mheDoc.data().submittedDrivers||{};
    for(let item of checklistItems){
      for(let day in submittedDrivers){
        for(let driver of submittedDrivers[day]){
          let row=`<tr><td>${mheId}</td><td>${item}</td><td>${driver}</td>`;
          const approvalStatus = approvals[day]?.[driver]?.status || "Pending";
          if(approvalStatus==='Approved'){
            row+=`<td>✅</td>`;
          } else {
            row+=`<td><button class="approve-btn" data-mhe="${mheId}" data-driver="${driver}" data-day="${day}">Approve</button></td>`;
          }
          for(let d=1; d<=daysInMonth; d++){
            const mark = data[item]?.[d.toString()] || "-";
            row+=`<td>${mark}</td>`;
          }
          row+="</tr>";
          table.innerHTML+=row;
        }
      }
    }
  }

  // Attach click listeners
  document.querySelectorAll(".approve-btn").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      await approveChecklist(btn.dataset.mhe, btn.dataset.driver, btn.dataset.day);
    });
  });
}

// ---- INITIALIZE ----
populateMonths();
loadTable();
window.submitForm=submitForm;
window.loadTable=loadTable;
window.approveChecklist=approveChecklist;
</script>
</body>
</html>
