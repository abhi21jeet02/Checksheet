<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MHE Checklist</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { color: #2c3e50; }
    .checklist { margin: 20px 0; }
    .checklist label { display: block; margin: 5px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    table, th, td { border: 1px solid #ccc; text-align: center; }
    th, td { padding: 8px; }
    select, button, input { margin: 5px; padding: 6px; }
  </style>
</head>
<body>
  <h2>MHE Daily Checklist</h2>

  <!-- Form Section -->
  <div id="form-section">
    <h3>Fill Checklist (Today)</h3>
    <label>Driver Name: <input type="text" id="driverName" placeholder="Enter Driver Name"></label>
    <div class="checklist">
      <label><input type="checkbox" id="Brakes"> Brakes</label>
      <label><input type="checkbox" id="Steering"> Steering</label>
      <label><input type="checkbox" id="Electrical"> Electrical System</label>
      <label><input type="checkbox" id="Wheel"> Wheel</label>
      <label><input type="checkbox" id="Lights"> Lights</label>
    </div>
    <button onclick="submitForm()">Submit</button>
  </div>

  <!-- View Section -->
  <div id="view-section">
    <h3>View Submissions</h3>
    <select id="monthSelect" onchange="loadTable()"></select>
    <table id="submissionTable"></table>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, doc, collection, getDoc, setDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBx_26h3CD_fRCILcmWLuDUc8v8pzH8Sxo",
      authDomain: "mhe-checksheet.firebaseapp.com",
      projectId: "mhe-checksheet",
      storageBucket: "mhe-checksheet.appspot.com",
      messagingSenderId: "413824836416",
      appId: "1:413824836416:web:63faa90294e161363510a5",
      measurementId: "G-ZQ77KHXXVB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const MHE_ID = urlParams.get("mhe_id") || "MHE1";

    const checklistItems = ["Brakes", "Steering", "Electrical", "Wheel", "Lights"];

    // ---- CHECK ALREADY SUBMITTED ----
    async function checkAlreadySubmitted() {
      const driverNameInput = document.getElementById("driverName").value.trim();
      if (!driverNameInput) {
        alert("Driver Name is required!");
        return false;
      }
      window.currentDriver = driverNameInput;

      const today = new Date();
      const day = today.getDate().toString();
      const monthKey = today.getFullYear() + "-" + String(today.getMonth() + 1).padStart(2, "0");

      const mheDocRef = doc(db, "checklists", monthKey, "MHEs", MHE_ID);
      const snap = await getDoc(mheDocRef);

      if (snap.exists()) {
        const data = snap.data();
        const submittedDrivers = data.submittedDrivers || {};
        const todayDrivers = submittedDrivers[day] || [];
        if (todayDrivers.includes(driverNameInput)) {
          alert(`Driver ${driverNameInput} has already submitted the checklist today ✅`);
          document.getElementById("form-section").style.display = "none";
          return false;
        }
      }
      return true;
    }

    // ---- FORM SUBMIT ----
    async function submitForm() {
      const isAllowed = await checkAlreadySubmitted();
      if (!isAllowed) return;

      const today = new Date();
      const day = today.getDate().toString();
      const monthKey = today.getFullYear() + "-" + String(today.getMonth() + 1).padStart(2, "0");

      const mheDocRef = doc(db, "checklists", monthKey, "MHEs", MHE_ID);
      const snap = await getDoc(mheDocRef);
      let data = snap.exists() ? snap.data() : { checklist: {}, submittedDrivers: {} };

      for (let item of checklistItems) {
        const checked = document.getElementById(item).checked ? "✔" : "✖";
        if (!data.checklist[item]) data.checklist[item] = {};
        data.checklist[item][day] = checked;
      }

      if (!data.submittedDrivers[day]) data.submittedDrivers[day] = [];
      data.submittedDrivers[day].push(window.currentDriver);

      if (snap.exists()) {
        await updateDoc(mheDocRef, data);
      } else {
        await setDoc(mheDocRef, data);
      }

      alert("Checklist submitted for today ✅");
      document.getElementById("form-section").style.display = "none";
    }

    // ---- POPULATE MONTH DROPDOWN ----
    function populateMonths() {
      const select = document.getElementById("monthSelect");
      const now = new Date();
      for (let i = 0; i < 6; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const key = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = d.toLocaleString("default", { month: "long", year: "numeric" });
        select.appendChild(opt);
      }
    }

    // ---- LOAD TABLE ----
    async function loadTable() {
      const monthKey = document.getElementById("monthSelect").value;
      const mheColRef = collection(db, "checklists", monthKey, "MHEs");
      const mheSnap = await getDocs(mheColRef);

      const table = document.getElementById("submissionTable");
      table.innerHTML = "";

      if (mheSnap.empty) {
        table.innerHTML = "<tr><td>No data for this month</td></tr>";
        return;
      }

      const daysInMonth = new Date(parseInt(monthKey.split("-")[0]), parseInt(monthKey.split("-")[1]), 0).getDate();

      let header = "<tr><th>MHE ID</th><th>Item</th>";
      for (let d = 1; d <= daysInMonth; d++) header += `<th>${d}</th>`;
      header += "</tr>";
      table.innerHTML += header;

      for (let mheDoc of mheSnap.docs) {
        const mheId = mheDoc.id;
        const data = mheDoc.data().checklist || {};
        for (let item of checklistItems) {
          let row = `<tr><td>${mheId}</td><td>${item}</td>`;
          for (let d = 1; d <= daysInMonth; d++) {
            const mark = data[item]?.[d.toString()] || "-";
            row += `<td>${mark}</td>`;
          }
          row += "</tr>";
          table.innerHTML += row;
        }
      }
    }

    // Initialize
    populateMonths();
    loadTable();
    window.submitForm = submitForm;
    window.loadTable = loadTable;
  </script>
</body>
</html>
