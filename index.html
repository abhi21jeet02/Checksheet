<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MHE Checklist - AI Style with Approval</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #1e293b, #111827); color: #f3f4f6; margin:0; padding:20px; min-height:100vh; }
    h2{text-align:center;font-weight:700;color:#3b82f6;margin-bottom:10px;}
    .subtitle{text-align:center;color:#9ca3af;margin-bottom:20px;}
    .card{background:rgba(255,255,255,0.05);border-radius:20px;padding:20px;margin-bottom:20px;backdrop-filter:blur(10px);box-shadow:0 8px 32px rgba(0,0,0,0.2);border:1px solid rgba(59,130,246,0.15);transition:transform 0.3s, box-shadow 0.3s;}
    label{display:block;margin:12px 0;font-weight:500;color:#f3f4f6;}
    input[type="text"]{width:100%;padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:#f3f4f6;outline:none;font-size:15px;transition: all 0.2s;}
    .checklist{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;}
    .checklist label{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.03);cursor:pointer;}
    .checklist input[type="checkbox"]{width:20px;height:20px; accent-color:#3b82f6;}
    button{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-weight:600;padding:10px 18px;border:none;border-radius:12px;cursor:pointer;font-size:15px;transition: all 0.2s;}
    .muted{color:#9ca3af;font-size:14px;}
    .status-badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:600;margin-left:8px;}
    .status-pending{background:#7f1d1d;color:#fff;}
    .status-submitted{background:#92400e;color:#fff;}
    .status-approved{background:#065f46;color:#fff;}
    .status-rejected{background:#374151;color:#fff;}
    table{width:100%;border-collapse:collapse;margin-top:14px;}
    th, td{padding:10px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.03);font-weight:500;color:#f3f4f6;}
    th{background: rgba(59,130,246,0.12);}
    .small{font-size:13px;color:#cbd5e1;}
    .alert{background: rgba(220,38,38,0.12); color:#fecaca; padding:10px 12px; border-radius:8px; margin-bottom:10px;}
    .ok{background: rgba(16,185,129,0.08); color:#bbf7d0; padding:10px 12px; border-radius:8px; margin-bottom:10px;}

    @media (max-width:768px){.checklist{flex-direction:column;}input[type="text"],button{font-size:14px;}#role-section,#form-section,#view-section{padding:15px;}table{display:block;overflow-x:auto;white-space:nowrap;}}
    @media (max-width:480px){.card button{width:100%;margin-top:8px;}.card div[style*="display:flex; gap:10px;"]{flex-direction:column;}input[type="text"]{font-size:13px;padding:8px;}.status-badge{padding:4px 6px;font-size:12px;}}
  </style>
</head>
<body>
  <h2>MHE Daily Checklist</h2>
  <div class="subtitle">Scan QR on the MHE → assigned driver auto-filled → fill checklist → submit</div>

  <!-- Role Selection -->
  <div class="card" id="role-section">
    <h3>Select Role</h3>
    <label class="muted">This QR must contain <code>?mhe_id=MHE1</code> (or respective MHE). Submission blocked if missing.</label>
    <select id="roleSelect" onchange="toggleRole()">
      <option value="">-- Select --</option>
      <option value="driver">Driver</option>
      <option value="supervisor">Supervisor</option>
    </select>
  </div>

 <!-- Driver Form -->
<div class="card" id="form-section" style="display:none;">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0">Fill Checklist (Today)</h3>
    <div id="todayStatusContainer"></div>
  </div>
  <label>Driver Name / ID: 
    <input type="text" id="driverName" placeholder="Auto-filled if assigned from Key Holder">
  </label>

  <!-- Checklist container (auto-filled via JS) -->
  <div class="checklist" id="checklistContainer"></div>

  <div style="margin-top:12px;">
    <label class="muted small">Optional remark: 
      <input type="text" id="driverRemark" placeholder="Add remark (if any)">
    </label>
  </div>
  <div style="display:flex; gap:10px; margin-top:14px;">
    <button onclick="submitForm()">Submit / Update Today</button>
    <button onclick="clearDriverForm()">Clear</button>
  </div>
  <div id="driverMeta" class="small" style="margin-top:10px;"></div>
</div>


  <!-- Supervisor View -->
  <div class="card" id="view-section" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">Supervisor View — Submissions & Approvals</h3>
      <div>
        <label class="muted small">Month: </label>
        <select id="monthSelect" onchange="loadTable()"></select>
      </div>
    </div>
   <div style="margin-top:10px; display:flex; gap:10px;">
  <button id="toggleAllMHEs" onclick="toggleAllMHEs()">View All MHEs</button>
  <button onclick="downloadExcel()">Download Excel</button>
</div>

    <div id="todayAlert"></div>

<!-- Wrap supervisor table inside scroll container -->
<div style="overflow-x:auto; max-width:100%; margin-top:10px;">
  <table id="submissionTable" style="width:max-content; min-width:100%;"></table>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, doc, collection, getDoc, setDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

/* --- CONFIG --- */
const firebaseConfig = {
  apiKey: "AIzaSyBx_26h3CD_fRCILcmWLuDUc8v8pzH8Sxo",
  authDomain: "mhe-checksheet.firebaseapp.com",
  projectId: "mhe-checksheet",
  storageBucket: "mhe-checksheet.appspot.com",
  messagingSenderId: "413824836416",
  appId: "1:413824836416:web:63faa90294e161363510a5",
  measurementId: "G-ZQ77KHXXVB"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* --- PARAMETERS & ITEMS --- */
const urlParams = new URLSearchParams(window.location.search);
const MHE_ID = urlParams.get("mhe_id");
// ✅ Replace your old checklistItems array with this one
const checklistItems = [
  "Reflective jacket",
  "Safety helmet and Safety shoes",
  "Driving authorization card",
  "Fork",
  "Safety Pin",
  "Chain",
  "Head Lamp",
  "Both Side wheel",
  "Hydraulic OIL",
  "Hydraulic cylinder leakage",
  "Back light tail lamp",
  "Horn",
  "Hoist lever",
  "Tilt lever",
  "Both side mirror",
  "Back Horn",
  "Hand break",
  "Gear lever",
  "Steering",
  "Cleaning",
  "TYRES",
  "CHARGING",
  "FOCUE BLUE LIGHT",
  "SEAT BELT",
  "Brake and Accelerator",
  "Wiring and cables"
];

/* --- RENDER CHECKLIST --- */
function renderChecklist(){
  const container = document.getElementById("checklistContainer");
  container.innerHTML = "";
  checklistItems.forEach(item=>{
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" id="${item}"> ${item}`;
    container.appendChild(label);
  });
}
renderChecklist();


/* --- UI helpers --- */
function show(el){ el.style.display = "block"; }
function hide(el){ el.style.display = "none"; }
let showAllMHEs = false;
window.toggleAllMHEs = function(){ showAllMHEs = !showAllMHEs; document.getElementById("toggleAllMHEs").textContent = showAllMHEs ? "View Only QR MHE" : "View All MHEs"; loadTable(); };

/* --- ROLE TOGGLE --- */
window.toggleRole = function(){
  const role = document.getElementById("roleSelect").value;
  const form = document.getElementById("form-section");
  const view = document.getElementById("view-section");
  
  if(role === "driver"){ show(form); hide(view); loadTodayForDriver(); } 
  else if(role === "supervisor"){
    const passkey = prompt("Enter Supervisor Passkey:");
    const correctKey = "SUP123";
    if(passkey !== correctKey){ alert("❌ Incorrect passkey!"); document.getElementById("roleSelect").value = ""; hide(form); hide(view); return; }
    hide(form); show(view); populateMonths(); setTimeout(()=> loadTable(),100);
  } else { hide(form); hide(view); }
};

/* --- UTILS --- */
function getTodayParts(){ const now = new Date(); return { day:String(now.getDate()), monthKey:now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,"0"), isoTime:now.toISOString(), pretty:now.toLocaleString() }; }
function ensureMheIdPresent(){ if(!MHE_ID){ alert("⚠️ MHE ID missing! Scan valid MHE QR."); document.getElementById("roleSelect").value=""; hide(document.getElementById("form-section")); hide(document.getElementById("view-section")); return false;} return true; }

/* --- FETCH DRIVER ASSIGNED FROM KEY HOLDER --- */
async function fetchAssignedDriver(){
  if(!ensureMheIdPresent()) return null;
  
  try{
    const assignmentRef = doc(db,"assignments",MHE_ID);  // doc ID = MHE1, MHE2, etc
    const snap = await getDoc(assignmentRef);
    if(!snap.exists()) return null;

    const data = snap.data();
    if(data.active && data.driver){ 
        document.getElementById("driverName").value = data.driver; 
        window.currentDriver = data.driver;  // save globally
        return data.driver; 
    }
  }catch(err){
    console.error("Error fetching driver:", err);
  }
  return null;
}

/* --- LOAD DRIVER TODAY --- */
async function loadTodayForDriver(){
  if(!ensureMheIdPresent()) return;
  const assignedDriver = await fetchAssignedDriver();
  if(!assignedDriver){
      alert("⚠️ No driver assigned via Key Holder. Pick key first!");
      clearDriverForm();
      return;
  }

  const { day, monthKey } = getTodayParts();
  const ref = doc(db,"checklists",monthKey,"MHEs",MHE_ID);
  const snap = await getDoc(ref);

  document.getElementById("driverMeta").textContent = "";
  for(const it of checklistItems) document.getElementById(it).checked=false;
  document.getElementById("driverRemark").value="";

  if(snap.exists()){
    const data = snap.data();
    const submittedDrivers = data.submittedDrivers||{};
    const checklist = data.checklist||{};
    const todayDrivers = submittedDrivers[day]||[];
    if(todayDrivers.includes(assignedDriver)){
      for(const it of checklistItems){ 
        document.getElementById(it).checked = checklist[it]?.[day]==="✔"; 
      }
      document.getElementById("driverRemark").value = data.remarks?.[day]?.[assignedDriver]||"";
      document.getElementById("driverMeta").textContent = `You already submitted today — updating will overwrite entry.`;
    }
  }
}

/* --- SUBMIT --- */
async function submitForm(){
  if(!ensureMheIdPresent()) return;

  // Force check: only assigned driver can submit
  const assignedDriver = await fetchAssignedDriver();
  if(!assignedDriver){
      alert("⚠️ No driver assigned via Key Holder. Submission not allowed.");
      return;
  }

  const driver = assignedDriver; // ✅ Manual entry ignore karo
  const remark = document.getElementById("driverRemark").value.trim();
  const { day, monthKey, isoTime, pretty } = getTodayParts();
  const mheDocRef = doc(db,"checklists",monthKey,"MHEs",MHE_ID);
  const snap = await getDoc(mheDocRef);
  let data = snap.exists()?snap.data():{checklist:{},submittedDrivers:{},approvals:{},remarks:{},status:{}};

  for(let it of checklistItems){ 
      data.checklist[it] = data.checklist[it]||{}; 
      data.checklist[it][day] = document.getElementById(it).checked?"✔":"✖"; 
  }

  data.submittedDrivers[day] = data.submittedDrivers[day]||[];
  if(!data.submittedDrivers[day].includes(driver)) data.submittedDrivers[day].push(driver);

  data.remarks[day] = data.remarks[day]||{}; 
  data.remarks[day][driver] = remark;

  data.status[day] = data.status[day]||{}; 
  data.status[day][driver] = { state:"Submitted", submittedBy:driver, submittedAt:isoTime };

  data.approvals[day] = data.approvals[day]||{}; 
  data.approvals[day][driver] = { status:"Pending" };

  if(snap.exists()) await updateDoc(mheDocRef,data); 
  else await setDoc(mheDocRef,data);

// deactivate assignment in Key Holder collection// 
// const assignmentRef = doc(db,"assignments",MHE_ID);// 
// await updateDoc(assignmentRef,{ active:false });// 
  alert("Checklist submitted/updated for today ✅");
  document.getElementById("driverMeta").textContent = `Submitted by ${driver} at ${pretty}. Status: Submitted`;
}

/* --- CLEAR FORM --- */
window.clearDriverForm = function(){ document.getElementById("driverName").value=""; for(const it of checklistItems) document.getElementById(it).checked=false; document.getElementById("driverRemark").value=""; document.getElementById("driverMeta").textContent=""; }

/* --- POPULATE MONTH DROPDOWN --- */
function populateMonths(){
    const monthSelect = document.getElementById("monthSelect");
    monthSelect.innerHTML = "";
    const now = new Date();
    for(let i=0;i<12;i++){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const val = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
        const text = d.toLocaleString('default',{month:'long', year:'numeric'});
        const option = document.createElement("option");
        option.value = val;
        option.textContent = text;
        monthSelect.appendChild(option);
    }
}

/* --- LOAD SUPERVISOR TABLE --- */
async function loadTable(){
    if(!ensureMheIdPresent()) return;

    const monthKey = document.getElementById("monthSelect").value;
    if(!monthKey) return;
    const table = document.getElementById("submissionTable");
    table.innerHTML = "";

    const monthRef = collection(db,"checklists",monthKey,"MHEs");
    const snap = await getDocs(monthRef);

    const allData = [];
    snap.forEach(docSnap=>{
        const data = docSnap.data();
        allData.push({ mheId: docSnap.id, ...data });
    });

    // Filter if showAllMHEs = false
    const displayData = showAllMHEs ? allData : allData.filter(d=>d.mheId===MHE_ID);

  // Build table header dynamically
const thead = document.createElement("thead");
const tr = document.createElement("tr");
tr.innerHTML = `<th>MHE</th><th>Driver</th><th>Day</th>`;
checklistItems.forEach(it=>{
  tr.innerHTML += `<th>${it}</th>`;
});
tr.innerHTML += `<th>Remark</th><th>Status</th><th>Approve</th><th>Reject</th>`;
thead.appendChild(tr);
table.appendChild(thead);

// Build rows
const tbody = document.createElement("tbody");
for(const mheData of displayData){
  const {mheId, checklist={}, remarks={}, approvals={}, status={}, submittedDrivers={}} = mheData;
  for(const day in submittedDrivers){
    for(const driver of submittedDrivers[day]){
      const tr = document.createElement("tr");
      let rowHtml = `<td>${mheId}</td><td>${driver}</td><td>${day}</td>`;
      checklistItems.forEach(it=>{
        rowHtml += `<td>${checklist[it]?.[day]||""}</td>`;
      });
      rowHtml += `
        <td>${remarks?.[day]?.[driver]||""}</td>
        <td>${approvals?.[day]?.[driver]?.status||"Pending"}</td>
        <td><button onclick="approveChecklist('${mheId}','${driver}','${day}')">✔</button></td>
        <td><button onclick="rejectChecklist('${mheId}','${driver}','${day}')">✖</button></td>
      `;
      tr.innerHTML = rowHtml;
      tbody.appendChild(tr);
    }
  }
}
table.appendChild(tbody);


    showTodaySubmissionAlert(monthKey);
}

/* --- APPROVE / REJECT --- */
async function approveChecklist(mheId, driver, day){
    const monthKey = document.getElementById("monthSelect").value;
    const docRef = doc(db,"checklists",monthKey,"MHEs",mheId);
    const snap = await getDoc(docRef);
    if(!snap.exists()) return;

    const data = snap.data();
    data.approvals = data.approvals||{};
    data.approvals[day] = data.approvals[day]||{};
    data.approvals[day][driver] = { status:"Approved", approvedAt:(new Date()).toISOString() };

    data.status = data.status||{};
    data.status[day] = data.status[day]||{};
    data.status[day][driver].state = "Approved";

    await updateDoc(docRef,data);
    alert(`✅ Checklist approved for ${driver} on ${day}`);
    loadTable();
}

async function rejectChecklist(mheId, driver, day){
    const monthKey = document.getElementById("monthSelect").value;
    const docRef = doc(db,"checklists",monthKey,"MHEs",mheId);
    const snap = await getDoc(docRef);
    if(!snap.exists()) return;

    const data = snap.data();
    data.approvals = data.approvals||{};
    data.approvals[day] = data.approvals[day]||{};
    data.approvals[day][driver] = { status:"Rejected", rejectedAt:(new Date()).toISOString() };

    data.status = data.status||{};
    data.status[day] = data.status[day]||{};
    data.status[day][driver].state = "Rejected";

    await updateDoc(docRef,data);
    alert(`❌ Checklist rejected for ${driver} on ${day}`);
    loadTable();
}

/* --- TODAY ALERT --- */
async function showTodaySubmissionAlert(monthKey){
    const { day } = getTodayParts();
    const table = document.getElementById("submissionTable");
    const rows = table.querySelectorAll("tbody tr");
    let alertText = "";
    rows.forEach(row=>{
        const rowDay = row.children[2].textContent; // Day column always 3rd
        if(rowDay === day){
            // Status column hamesha "Remark" ke baad aata hai → index = checklistItems.length + 4
            const statusColIndex = 3 + checklistItems.length + 1; 
            const status = row.children[statusColIndex].textContent.trim();
            if(status === "Pending"){
                alertText = "⚠️ Some submissions today are still pending approval.";
            }
        }
    });
    document.getElementById("todayAlert").innerHTML = alertText ? `<div class="alert">${alertText}</div>` : "";
}

/* --- INIT --- */
(function init(){ populateMonths(); })();

window.submitForm = submitForm;
window.loadTable = loadTable;
window.approveChecklist = approveChecklist;
window.rejectChecklist = rejectChecklist;
window.populateMonths = populateMonths;
window.loadTodayForDriver = loadTodayForDriver;
window.downloadExcel = async function(){
  const monthKey = document.getElementById("monthSelect").value;
  if(!monthKey){ alert("Select month first"); return; }

  const monthRef = collection(db,"checklists",monthKey,"MHEs");
  const snap = await getDocs(monthRef);

  const wb = XLSX.utils.book_new();

  snap.forEach(docSnap=>{
    const data = docSnap.data();
    const mheId = docSnap.id;

    // Dates 1–31 (columns)
    const dates = Array.from({length:31},(_,i)=>String(i+1));

    // Prepare matrix
    const rows = [];
    const header = ["Parameters", ...dates];
    rows.push(header);

    // Parameters list
    const parameters = [ "Reflective jacket",
  "Safety helmet and Safety shoes",
  "Driving authorization card",
  "Fork",
  "Safety Pin",
  "Chain",
  "Head Lamp",
  "Both Side wheel",
  "Hydraulic OIL",
  "Hydraulic cylinder leakage",
  "Back light tail lamp",
  "Horn",
  "Hoist lever",
  "Tilt lever",
  "Both side mirror",
  "Back Horn",
  "Hand break",
  "Gear lever",
  "Steering",
  "Cleaning",
  "TYRES",
  "CHARGING",
  "FOCUE BLUE LIGHT",
  "FOCUE BLUE LIGHT",
  "SEAT BELT",
  "Brake and Accelerator",
  "Wiring and cables","Remark","Status","Driver","Approval","Approved By"];

   parameters.forEach(param=>{
  const row = [param];
  dates.forEach(day=>{
    let val = "";
    const drivers = data.submittedDrivers?.[day]||[];
    const driver = drivers[0]||"";

    if(checklistItems.includes(param)){
      val = data.checklist?.[param]?.[day]||"";
    } else {
      switch(param){
        case "Remark": val = data.remarks?.[day]?.[driver]||""; break;
        case "Status": val = data.status?.[day]?.[driver]?.state||""; break;
        case "Driver": val = driver; break;
        case "Approval": val = data.approvals?.[day]?.[driver]?.status||""; break;
        case "Approved By": val = data.approvals?.[day]?.[driver]?.by||""; break;
      }
    }
    row.push(val);
  });
  rows.push(row);
});

    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, mheId);
  });

  XLSX.writeFile(wb, `MHE_Checklist_${monthKey}.xlsx`);
};


</script>
</body>
</html>
